# Webhook 測試介面設計文件

前端測試介面架構規劃文件，供使用者測試和管理 Webhook 訂閱功能。

## 📋 目錄

- [概述](#概述)
- [功能需求](#功能需求)
- [介面設計](#介面設計)
- [技術實作](#技術實作)
- [API 整合](#api-整合)
- [使用者流程](#使用者流程)

---

## 概述

### 目標

建立一個使用者友善的前端介面，讓使用者能夠：

1. **查看已授權商店的 Webhook 訂閱狀態**
2. **新增/刪除 Webhook 訂閱**
3. **監控 Webhook 事件接收情況**
4. **測試 Webhook 功能**

### 設計原則

- **簡單直觀**：操作流程清晰，減少學習成本
- **即時反饋**：操作結果立即顯示
- **錯誤處理**：友好的錯誤提示和處理
- **測試友善**：方便快速測試各種場景

---

## 功能需求

### 1. Webhook 訂閱管理

#### 1.1 查看訂閱列表
- **功能**：顯示指定商店的所有 Webhook 訂閱
- **顯示內容**：
  - 事件主題（Topic）
  - 訂閱 ID
  - Webhook URL
  - API 版本
  - 訂閱狀態
  - 建立時間

#### 1.2 新增訂閱
- **功能**：為指定商店新增 Webhook 訂閱
- **輸入欄位**：
  - 商店 Handle（下拉選單或輸入）
  - 事件主題（Topic）- 支援下拉選單選擇常用事件
  - Webhook URL（可切換測試站 / 正式站，預填當前 ngrok URL 或正式域名）
  - API 版本（預填 v20230901）

#### 1.3 刪除訂閱
- **功能**：取消指定的 Webhook 訂閱
- **確認機制**：刪除前需要確認

#### 1.4 訂閱統計
- **功能**：顯示訂閱數量統計
- **顯示內容**：
  - 總訂閱數
  - 依事件類型分類統計

### 2. Webhook 事件監測

#### 2.1 事件列表
- **功能**：顯示接收到的 Webhook 事件
- **顯示內容**：
  - 事件主題（Topic）
  - Webhook ID
  - 商店資訊
  - 接收時間
  - 處理狀態
  - 事件內容（可展開/收合）

#### 2.2 事件篩選
- **功能**：依條件篩選事件
- **篩選條件**：
  - 事件類型（Topic）
  - 商店
  - 處理狀態
  - 時間範圍

#### 2.3 事件詳情
- **功能**：查看單一事件的完整資訊
- **顯示內容**：
  - 所有 Headers 資訊
  - 完整 Payload
  - 簽名驗證狀態
  - 處理記錄

### 3. 測試功能

#### 3.1 快速測試
- **功能**：快速測試常用事件訂閱
- **操作**：僅針對 `products/update` 提供一鍵訂閱，做 MVP 測試用

#### 3.2 訂閱驗證
- **功能**：驗證訂閱是否成功
- **顯示**：訂閱後立即顯示狀態

---

## 介面設計

### 頁面結構（雙欄式布局）

```
┌─────────────────────────────────────────────────────────────────────┐
│  Header: Webhook 測試管理                                            │
├──────────────────────────┬──────────────────────────────────────────┤
│  左側欄（側邊欄）        │  右側欄（主要內容區）                      │
│                          │                                          │
│  ┌────────────────────┐ │  ┌──────────────────────────────────────┐ │
│  │ 商店選擇            │ │  │  📨 事件列表                         │ │
│  │ [Handle] ▼         │ │  │                                     │ │
│  └────────────────────┘ │  │  當前選中: orders/create              │ │
│                          │  │  [篩選: 狀態 ▼] [搜尋]               │ │
│  ┌────────────────────┐ │  │                                     │ │
│  │ [+ 新增訂閱]        │ │  │  ┌────────────────────────────────┐│ │
│  └────────────────────┘ │  │  │ ▶ orders/create                ││ │
│                          │  │  │   2025-01-03 10:30 | ✅已處理   ││ │
│  ┌────────────────────┐ │  │  │   [點擊展開詳情...]            ││ │
│  │ 📊 訂閱統計        │ │  │  └────────────────────────────────┘│ │
│  │ 總數: 5            │ │  │                                     │ │
│  │ orders: 2          │ │  │  ┌────────────────────────────────┐│ │
│  │ products: 2         │ │  │  │ ▶ orders/create                ││ │
│  │ others: 1           │ │  │  │   2025-01-03 09:15 | ⏳待處理   ││ │
│  └────────────────────┘ │  │  │   [點擊展開詳情...]            ││ │
│                          │  │  └────────────────────────────────┘│ │
│  ┌────────────────────┐ │  │                                     │ │
│  │ 📋 訂閱列表        │ │  │  ...                                │ │
│  │                     │ │  │                                     │ │
│  │  ┌────────────────┐│ │  │                                     │ │
│  │  │ ● orders/create││ │  │                                     │ │
│  │  │   (已選中)     ││ │  │                                     │ │
│  │  └────────────────┘│ │  │                                     │ │
│  │                     │ │  │                                     │ │
│  │  ┌────────────────┐│ │  │                                     │ │
│  │  │ ○ products/    ││ │  │                                     │ │
│  │  │   update       ││ │  │                                     │ │
│  │  │   [刪除]       ││ │  │                                     │ │
│  │  └────────────────┘│ │  │                                     │ │
│  │                     │ │  │                                     │ │
│  │  ┌────────────────┐│ │  │                                     │ │
│  │  │ ○ customers/  ││ │  │                                     │ │
│  │  │   create       ││ │  │                                     │ │
│  │  │   [刪除]       ││ │  │                                     │ │
│  │  └────────────────┘│ │  │                                     │ │
│  │                     │ │  │                                     │ │
│  │  ...                │ │  │                                     │ │
│  │                     │ │  │                                     │ │
│  └────────────────────┘ │  └──────────────────────────────────────┘ │
│                          │                                          │
└──────────────────────────┴──────────────────────────────────────────┘
```

### 布局說明

#### 左側欄（側邊欄）
- **寬度**：約 300-350px（固定或可調整）
- **位置**：頁面左側
- **內容區域（由上至下）**：
  1. **商店選擇**：下拉選單或輸入框
  2. **新增訂閱按鈕**：固定在頂部
  3. **訂閱統計卡片**：顯示統計資訊
  4. **訂閱列表**：佔用剩餘空間，可滾動

#### 右側欄（主要內容區）
- **寬度**：佔用剩餘空間（flex-1）
- **位置**：頁面右側
- **內容**：
  - **標題區域**：顯示當前選中的訂閱事件
  - **工具列**：篩選、搜尋功能
  - **事件列表**：顯示選中訂閱對應的事件
  - **事件詳情**：點擊事件卡片展開/收合詳情

### 互動邏輯

1. **選擇訂閱**：
   - 點擊左側訂閱列表中的任一訂閱項目
   - 該項目標記為「已選中」狀態（視覺上突出顯示）
   - 右側事件列表自動更新，顯示該訂閱對應的所有事件

2. **查看事件詳情**：
   - 點擊右側事件列表中的任一事件卡片
   - 該卡片展開顯示完整詳情（Headers、Payload 等）
   - 再次點擊收合

3. **新增訂閱**：
   - 點擊左側「新增訂閱」按鈕
   - 彈出表單對話框（Modal）
   - 完成後，訂閱列表自動更新

4. **刪除訂閱**：
   - 在左側訂閱列表中點擊「刪除」按鈕
   - 顯示確認對話框
   - 確認後移除訂閱，若該訂閱為當前選中，清空右側事件列表

### 元件設計

#### 1. Sidebar（側邊欄容器）
- **用途**：包含左側所有功能
- **布局**：
  - 固定寬度：300-350px
  - 可滾動區域：訂閱列表部分
- **內容**：
  - 商店選擇區域
  - 新增訂閱按鈕
  - 訂閱統計卡片
  - 訂閱列表

#### 2. StoreSelector（商店選擇器）
- **用途**：選擇要管理的商店
- **位置**：側邊欄頂部
- **顯示**：下拉選單或輸入框
- **行為**：選擇後刷新訂閱列表和統計

#### 3. SubscriptionList（訂閱列表）
- **用途**：顯示所有訂閱項目
- **位置**：側邊欄中下部（佔用剩餘空間）
- **Props**：
  - `subscriptions`: 訂閱陣列
  - `selectedTopic`: 當前選中的訂閱主題
  - `onSelect`: 選擇訂閱回調
  - `onDelete`: 刪除訂閱回調
- **顯示內容**：
  - 訂閱項目卡片（可點擊）
  - 已選中狀態視覺標示
  - 刪除按鈕（懸停顯示）

#### 4. SubscriptionItem（訂閱項目卡片）
- **用途**：顯示單一訂閱資訊
- **Props**：
  - `subscription`: 訂閱物件
  - `isSelected`: 是否為當前選中
  - `onSelect`: 選擇回調
  - `onDelete`: 刪除回調
- **內容**：
  - 事件主題（Topic）醒目標示
  - 已選中狀態：左側顯示實心圓點（●），背景色變化
  - 未選中狀態：左側顯示空心圓點（○）
  - 刪除按鈕（懸停時顯示）

#### 5. SubscriptionStats（訂閱統計卡片）
- **用途**：顯示訂閱統計資訊
- **位置**：側邊欄中部
- **內容**：
  - 總訂閱數
  - 依類型分類統計（orders、products、customers、others）
- **樣式**：卡片式設計，緊湊佈局

#### 6. MainContent（右側主要內容區）
- **用途**：顯示事件列表和詳情
- **布局**：
  - 佔用剩餘空間（flex-1）
  - 垂直滾動
- **內容**：
  - 標題區域（顯示當前選中訂閱）
  - 工具列（篩選、搜尋）
  - 事件列表

#### 7. EventListHeader（事件列表標題）
- **用途**：顯示當前選中的訂閱資訊和操作工具
- **內容**：
  - 當前選中訂閱顯示（例如：「當前選中: orders/create」）
  - 篩選下拉選單（狀態：全部/已處理/待處理）
  - 搜尋框（選用）

#### 8. WebhookEventCard（事件卡片，已存在，需擴充）
- **用途**：顯示單一事件資訊
- **位置**：右側事件列表中
- **Props**：
  - `event`: 事件物件
  - `isExpanded`: 是否展開（可選）
  - `onToggle`: 展開/收合回調
- **內容**：
  - **收合狀態**：
    - 事件主題
    - 接收時間
    - 處理狀態標籤
    - 提示文字：「點擊展開詳情...」
  - **展開狀態**：
    - 所有收合狀態內容
    - 完整 Headers 資訊（以表格或卡片形式）
    - 完整 Payload（JSON 格式，可複製）
    - 簽名驗證狀態
    - 處理記錄

#### 9. SubscriptionForm（訂閱表單，Modal）
- **用途**：新增訂閱表單
- **觸發**：點擊「新增訂閱」按鈕
- **顯示**：全屏遮罩 + 中央對話框
- **欄位**：
  - Handle 選擇/輸入
  - Topic 選擇（下拉選單，支援常用事件快速選擇）
  - Webhook URL（可切換測試站/正式站，預填當前 ngrok URL 或正式域名）
  - API 版本（預填 v20230901）
- **操作**：
  - 提交訂閱
  - 取消

---

## 技術實作

### 前端技術棧

- **框架**：Next.js 14（已使用）
- **狀態管理**：SWR（已使用）
- **UI 庫**：Tailwind CSS（已使用）
- **日期處理**：date-fns（已使用）

### 新增 Hooks

#### 1. useWebhookSubscriptions
```typescript
export function useWebhookSubscriptions(handle: string) {
  // 取得訂閱列表
  // 自動刷新
  // 錯誤處理
}
```

#### 2. useSubscribeWebhook
```typescript
export function useSubscribeWebhook() {
  // 新增訂閱 mutation
  // 成功/失敗處理
}
```

#### 3. useUnsubscribeWebhook
```typescript
export function useUnsubscribeWebhook() {
  // 刪除訂閱 mutation
  // 確認機制
}
```

### API 端點

#### 後端路由（已完成）
- `GET /webhook/subscribe?handle={handle}` - 取得訂閱列表
- `POST /webhook/subscribe` - 新增訂閱
- `DELETE /webhook/subscribe/:webhookId?handle={handle}` - 刪除訂閱
- `GET /webhook/subscribe/count?handle={handle}` - 取得訂閱數量

#### 前端 API Client 擴充
```typescript
// frontend/lib/api.ts

export const apiClient = {
  // ... 現有方法
  
  // Webhook 訂閱管理
  getWebhookSubscriptions: (handle: string) => 
    fetch(`${API_URL}/webhook/subscribe?handle=${handle}`),
  
  subscribeWebhook: (data: {
    handle: string
    topic: string
    webhookUrl: string
    apiVersion?: string
  }) => 
    fetch(`${API_URL}/webhook/subscribe`, {
      method: 'POST',
      body: JSON.stringify(data)
    }),
  
  unsubscribeWebhook: (webhookId: string, handle: string) => 
    fetch(`${API_URL}/webhook/subscribe/${webhookId}?handle=${handle}`, {
      method: 'DELETE'
    }),
  
  getWebhookCount: (handle: string) => 
    fetch(`${API_URL}/webhook/subscribe/count?handle=${handle}`)
}
```

---

## API 整合

### 常用事件主題列表

根據 SHOPLINE 官方文件，常用事件包括：

```typescript
const COMMON_TOPICS = [
  // 訂單相關
  'orders/create',
  'orders/update',
  'orders/paid',
  'orders/cancelled',
  
  // 商品相關
  'products/create',
  'products/update',
  'products/delete',
  
  // 客戶相關
  'customers/create',
  'customers/update',
  
  // GDPR（強制訂閱）
  'customers/redact',
  'merchants/redact'
]
```

### 預設 Webhook URL

從環境變數或配置取得當前 ngrok URL：
```typescript
const DEFAULT_WEBHOOK_URL = 
  process.env.NEXT_PUBLIC_NGROK_URL 
    ? `${process.env.NEXT_PUBLIC_NGROK_URL}/webhook/shopline`
    : `${window.location.origin}/webhook/shopline`
```

---

## 使用者流程

### 流程 1：新增訂閱

```
1. 在左側欄頂部選擇商店 Handle
2. 點擊左側欄「新增訂閱」按鈕
3. 開啟訂閱表單 Modal
4. 選擇/輸入事件主題
5. Webhook URL 可切換測試站/正式站，自動預填
6. 點擊「確認訂閱」
7. 顯示訂閱結果（成功/失敗）
8. 左側訂閱列表自動刷新
9. 訂閱統計自動更新
```

### 流程 2：查看訂閱對應的事件

```
1. 在左側欄選擇商店 Handle
2. 點擊左側訂閱列表中的任一訂閱項目
3. 該項目標記為「已選中」（視覺突出顯示）
4. 右側事件列表自動更新，顯示該訂閱的所有事件
5. 點擊右側事件卡片展開詳情
6. 查看完整 Headers 和 Payload
7. 再次點擊事件卡片收合
```

### 流程 3：刪除訂閱

```
1. 在左側訂閱列表中，將滑鼠懸停在要刪除的訂閱項目上
2. 點擊該項目右側的「刪除」按鈕
3. 顯示確認對話框
4. 確認刪除
5. 若該訂閱為當前選中，右側事件列表清空
6. 左側訂閱列表和統計自動更新
```

### 流程 4：快速測試（MVP）

```
1. 在左側欄選擇商店 Handle
2. 點擊「快速測試」按鈕（僅訂閱 products/update）
3. 自動訂閱 products/update 事件
4. 顯示訂閱進度
5. 訂閱完成後：
   - 左側訂閱列表顯示 products/update
   - 自動選中該訂閱
   - 右側顯示該訂閱的事件列表（如果已有事件）
   - 訂閱統計更新
```

---

## 實作優先順序

### Phase 1：核心功能
1. ✅ Webhook 訂閱列表顯示
2. ✅ 新增訂閱表單
3. ✅ 刪除訂閱功能
4. ✅ 訂閱統計顯示

### Phase 2：進階功能
5. ✅ 事件列表增強（使用已存在的 WebhookEventCard）
6. ✅ 事件篩選功能
7. ✅ 事件詳情展開/收合

### Phase 3：測試功能
8. ✅ 快速測試功能
9. ✅ 測試結果驗證

---

## 注意事項

### 測試環境
- 使用 `paykepoc` 作為預設測試商店
- Webhook URL 使用當前 ngrok URL
- 允許較低資安標準（測試階段）

### 錯誤處理
- API 請求失敗時顯示友好錯誤訊息
- Token 過期時提示重新授權
- 商店不存在時顯示提示

### 效能考量
- 訂閱列表使用 SWR 自動刷新（間隔 10 秒）
- 事件列表使用分頁（50 筆）
- 大量事件時使用虛擬滾動（選用）

---

## 相關文件

- [Webhook 使用指南](docs/WEBHOOK_GUIDE.md)
- [系統架構](docs/ARCHITECTURE.md)
- [App Bridge 指南](docs/APP_BRIDGE.md)

---

**文件版本**: v1.0.0  
**建立日期**: 2025-01-03  
**維護者**: Mo Studio

