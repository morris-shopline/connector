# Issue 2025-11-10-001: Auth 流程被搞壞（正式環境）

**建立日期**: 2025-11-10  
**狀態**: ✅ resolved  
**優先級**: 🔴 Critical  
**相關 Run**: run-2025-11-10-01, run-2025-11-11-01  
**相關 Story**: 
- [Story R3.0: Connection 資料模型與 Migration](../stories/story-r3-0-connection-data-model.md)
- [Story R3.1: Connection 狀態同步](../stories/story-r3-1-connection-state-sync.md)
- [Story R3.2: Token Lifecycle 與重新授權流程](../stories/story-r3-2-token-lifecycle.md)

---

## 問題描述

**正式推上線後發現**：OAuth 授權流程（auth callback）被搞壞了，返回 `Invalid signature` 錯誤。

**錯誤訊息**：
```json
{"success": false, "error": "Invalid signature"}
```

**發生位置**：
- URL: `api/auth/shopline/callback?appkey=...`
- 環境：正式環境（production）
- 時間：Run 2025-11-10-01 推上線後

**影響範圍**：
- ⚠️ **Critical**：用戶無法完成 OAuth 授權流程
- 無法新增商店授權
- 無法重新授權已過期的 Token

---

## 重現步驟

1. 在正式環境訪問 OAuth 授權流程
2. 完成 Shopline 授權後，回調到 `api/auth/shopline/callback`
3. 收到 `Invalid signature` 錯誤

**預期行為**：授權成功，建立或更新 Connection

**實際行為**：返回 `Invalid signature` 錯誤

---

## 初步分析

### 可能原因

1. **簽名驗證邏輯變更**：
   - Run 2025-11-10-01 中可能修改了 OAuth callback 處理邏輯
   - 簽名驗證邏輯可能被錯誤修改或移除

2. **環境變數問題**：
   - 正式環境的環境變數可能與本地開發環境不同
   - `SHOPLINE_APP_SECRET` 或其他相關環境變數可能未正確設定

3. **資料結構變更影響**：
   - R3.0 的資料模型變更可能影響了 OAuth callback 的處理邏輯
   - Connection 相關的資料結構變更可能導致簽名驗證失敗

4. **後端路由變更**：
   - `/api/auth/shopline/callback` 路由的處理邏輯可能被錯誤修改

---

## 影響範圍

### 受影響的功能
- ⚠️ **OAuth 授權流程**：完全無法使用
- ⚠️ **新增商店授權**：無法完成
- ⚠️ **重新授權流程**：無法完成（R3.2 的功能）

### 受影響的用戶
- 所有需要新增商店授權的用戶
- 需要重新授權已過期 Token 的用戶

---

## 緊急程度

🔴 **Critical**：
- 核心功能（OAuth 授權）完全無法使用
- 影響用戶體驗和系統可用性
- 需要立即修復

---

## 待辦事項

- [ ] 檢查 Run 2025-11-10-01 中對 OAuth callback 的修改
- [ ] 檢查正式環境的環境變數設定
- [ ] 檢查簽名驗證邏輯是否正確
- [ ] 檢查資料結構變更是否影響 OAuth callback
- [ ] 本地環境重現問題（如果可能）
- [ ] 修復問題並測試
- [ ] 推上線並驗證

---

## 相關文件

- **Run 記錄**：`docs/archive/old-runs/run-2025-11-10-01.md`
- **OAuth 授權流程**：`docs/reference/guides/DEPLOYMENT_GUIDE.md`
- **後端路由**：`backend/src/routes/auth.ts`
- **Shopline Service**：`backend/src/services/shopline.ts`

---

## 處理狀態

**當前狀態**：✅ resolved  
**處理 Run**：run-2025-11-11-01  
**修復時間**：2025-11-11

## 修復內容

**根本原因**：
- OAuth callback 的簽名驗證邏輯未包含 `code` 參數
- 根據 Shopline API 文件，簽名驗證應該包含所有參數（除了 `sign` 本身）
- `verifyCallbackParams` 只包含了 `appkey`, `handle`, `timestamp`, `sign`，缺少 `code`

**修復方式**：
1. 更新 `ShoplineAuthParams` 類型定義，新增可選的 `code` 參數
2. 修復 OAuth callback 簽名驗證邏輯，在 `verifyCallbackParams` 中包含 `code` 參數

**修改檔案**：
- `backend/src/types.ts`: 更新 `ShoplineAuthParams` 類型定義
- `backend/src/routes/auth.ts`: 修復 OAuth callback 簽名驗證邏輯

**測試狀態**：
- ✅ Agent 測試完成（類型檢查、linter 檢查通過）
- ✅ 地端測試完成（功能正常）
- ✅ 已推上正式環境（Commit: 24acfba）
- ⏳ 待正式環境 User Test 驗證

**部署狀態**：
- **Commit**: `24acfba`
- **推送時間**: 2025-11-11
- **狀態**: 已推送到 `origin/main`，等待自動部署
- **正式環境 URL**:
  - 前端：`https://connector-theta.vercel.app/`
  - 後端：`https://connector-o5hx.onrender.com/`

---

**最後更新**: 2025-11-11

