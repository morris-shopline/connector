# Issue 2025-11-07-001: OAuth Token 過期時誤觸發 Admin 登出

**建立日期**: 2025-11-07  
**狀態**: ✅ resolved（2025-11-10，由 Story R3.2 處理）  
**優先級**: High  
**相關 Run**: run-2025-11-06-01  
**相關 Story**: [Story 3.5: OAuth 授權流程與會員登入系統銜接](../stories/story-3-5-oauth-auth-integration.md)

---

## 問題描述

在使用者已登入 Admin 介面的情況下，如果後端儲存的商店 API Token 已過期，當使用者操作任何需要有效 Token 的功能（例如 `webhook-test` 頁面、Admin API 測試頁面）時，系統會直接觸發全域登出，導致使用者被導回登入頁面。

這個行為與預期不符。Token 過期應該提示使用者重新授權商店，而不是中斷 Admin 登入狀態。

---

## 重現步驟

1. 使用帳號登入 Admin 介面。
2. 將該帳號綁定的商店 API Token 手動設為過期（或等待自然過期）。
3. 在前端進入需要 Token 的頁面或操作：
   - `frontend/pages/webhook-test.tsx`
   - `frontend/pages/admin-api-test.tsx`
4. 觸發資料讀取或 API 呼叫。

**實際行為**：請求返回 Token 過期錯誤後，全域狀態判定為未授權，立即登出 Admin。

**預期行為**：保留 Admin 登入狀態，顯示 Token 過期提示，要求重新授權商店或刷新 Token。

---

## 影響範圍

- 前端：所有依賴商店 Token 的頁面（Webhooks 檢視、Admin API 測試）。
- 後端：OAuth Token 驗證邏輯、錯誤處理與對應的 Session 判定。
- 使用者體驗：造成不必要的登出，難以理解真實問題（看起來像登入過期）。

---

## 初步分析

- 後端或前端可能將 `401`/`403` Token 過期錯誤視為認證失敗，進而觸發 `logout` 或 `clearSession`。
- 缺乏針對 Token 過期的錯誤型別區分（應與 Session 過期分開處理）。
- 前端缺少 Token 過期的 UI/UX 流程（彈窗、提示、重新授權流程）。

---

## 建議解法方向

1. **錯誤分類**：後端 API 在 Token 過期時回傳可辨識的錯誤碼（例如 `TOKEN_EXPIRED`）。
2. **前端處理**：
   - 攔截 `TOKEN_EXPIRED`，顯示彈窗或 toast 提示。
   - 提供重新授權商店的動作（導向 OAuth 流程）。
   - 保留 Admin 登入狀態，不要觸發全域登出。
3. **Session 驗證邏輯**：確保僅在 Session/登入態失效時才登出。

---

## 待辦事項

- [x] 架構討論（2025-11-07）決定 Token lifecycle 與錯誤碼策略（`docs/archive/discussions/discussion-2025-11-07-multi-store-architecture.md`）
- [x] Story R3.2 實作後端錯誤碼與前端重新授權流程，保留登入狀態（2025-11-10）
- [x] Story R3.2 驗收：涵蓋 Token 過期、Scope 改變、多商店同時過期等情境測試（✅ User Test 通過，2025-11-10）

---

**預計處理時間**: Epic 4 第一波 Run（2025-11 中旬預估完成）

---

**最後更新**: 2025-11-07


